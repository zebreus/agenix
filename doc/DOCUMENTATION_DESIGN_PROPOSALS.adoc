= Agenix Documentation Reorganization - Design Proposals

This document presents multiple design options for reorganizing the agenix documentation. The goal is to create a clean, minimal, and well thought out structure that addresses the current issues.

== Current State Analysis

=== Current Documentation Files

[cols="1,1,2", options="header"]
|===
| File | Format | Content

| `README.md`
| Markdown
| Main readme with quick start, installation, links

| `doc/readme.adoc`
| AsciiDoc
| Tutorial, module reference, CLI reference, threat model

| `pkgs/README.md`
| Markdown
| Full CLI documentation including generators

| `test/README.md`
| Markdown
| Test infrastructure documentation

| `test/example_secret_reference/README.md`
| Markdown
| Example documentation for secret references
|===

=== Current Issues

1. **Mixed Formats**: Uses both Markdown and AsciiDoc inconsistently
2. **Scattered CLI Documentation**: CLI docs exist in both `doc/readme.adoc` and `pkgs/README.md`
3. **No Dedicated secrets.nix Reference**: Format documentation is scattered/missing
4. **Module Documentation**: Missing newer features like `public.path`, `public.content`, generator support
5. **No Manpage**: CLI lacks a proper manpage
6. **Duplicate Content**: CLI reference duplicated in multiple places
7. **Outdated Information**: Some CLI flags are out of sync with the actual implementation

=== Components to Document

* **CLI** (`agenix` binary)
  - Commands: edit, encrypt, decrypt, rekey, generate
  - Global options
  - Environment variables
  - Generators (built-in functions, automatic selection)
  
* **secrets.nix Format**
  - Basic structure
  - Fields: publicKeys, armor, generator, dependencies
  - Secret reference syntax
  - Generator functions (return values, dependencies)
  - Examples

* **NixOS Module** (`modules/age.nix`)
  - age.ageBin
  - age.secrets.* (name, file, path, mode, owner, group, symlink)
  - age.secrets.*.public.{path, content}
  - age.secretsDir
  - age.secretsMountPoint
  - age.identityPaths

* **Home Manager Module** (`modules/age-home.nix`)
  - age.package
  - age.secrets.* (name, file, path, mode, symlink)
  - age.secrets.*.public.{path, content}
  - age.secretsDir
  - age.secretsMountPoint
  - age.identityPaths

---

== Design Proposal A: Centralized Documentation

All documentation consolidated in a single `doc/` directory with a clear hierarchy.

=== Directory Structure

----
doc/
├── readme.adoc           # Main documentation (renamed from current)
├── cli.adoc             # CLI reference (manpage source)
├── secrets-nix.adoc     # secrets.nix format reference
├── nixos-module.adoc    # NixOS module reference
├── home-manager.adoc    # Home Manager module reference
└── manpage.nix          # Nix expression to build manpage

README.md                # Project overview (keep as-is)
pkgs/
└── (no README - all docs in doc/)
modules/
└── (no README - all docs in doc/)
----

=== Documentation Flow

----
README.md (entry point)
    ├── Quick Example
    ├── Installation
    └── Links to doc/readme.adoc
    
doc/readme.adoc (main docs)
    ├── Introduction
    ├── Tutorial
    ├── Threat Model
    └── Links to specific references:
        ├── doc/cli.adoc
        ├── doc/secrets-nix.adoc
        ├── doc/nixos-module.adoc
        └── doc/home-manager.adoc
----

=== Pros

* Single source of truth for all documentation
* Easy to navigate and maintain
* Clear separation of concerns
* Works well with existing `pkgs/doc.nix` build

=== Cons

* Removes documentation from near the code (pkgs/README.md)
* Larger doc/ directory
* May feel less discoverable for CLI-specific information

---

== Design Proposal B: Component-Coupled Documentation

Documentation lives near the code it documents, with cross-references.

=== Directory Structure

----
README.md                    # Project overview
doc/
├── readme.adoc             # Main tutorial & concepts
├── secrets-nix.adoc        # secrets.nix format (related to CLI)
└── build-docs.nix          # Build all documentation

pkgs/
├── README.md → README.adoc # CLI documentation (renamed to adoc)
└── manpage.adoc            # CLI manpage source (same content)

modules/
├── README.adoc             # Module documentation (new)
├── age.nix
└── age-home.nix
----

=== Documentation Flow

----
README.md (entry point)
    └── Links to all components:
        ├── doc/readme.adoc (tutorial)
        ├── pkgs/README.adoc (CLI)
        ├── modules/README.adoc (modules)
        └── doc/secrets-nix.adoc
----

=== Pros

* Documentation close to code
* Self-contained components
* Easy to find relevant docs when browsing code
* Natural place for pkgs/ documentation

=== Cons

* Documentation scattered across directories
* Harder to maintain consistency
* secrets.nix docs placement is awkward (more related to CLI)

---

== Design Proposal C: Minimal Unified Approach

Keep current structure but consolidate and standardize.

=== Directory Structure

----
README.md                    # Project overview (enhanced)
doc/
├── readme.adoc             # Comprehensive documentation (all-in-one)
│   ├── Introduction
│   ├── Tutorial  
│   ├── CLI Reference
│   ├── secrets.nix Reference
│   ├── NixOS Module Reference
│   ├── Home Manager Reference
│   └── Threat Model
├── manpage.adoc            # CLI manpage (extracted subset)
└── doc.nix                 # Build documentation

pkgs/
└── (README.md removed - reference doc/readme.adoc)

modules/
└── (no documentation files)
----

=== Documentation Flow

----
README.md (minimal entry)
    └── Links to doc/readme.adoc (everything)

doc/readme.adoc (comprehensive)
    ├── All sections in one file
    └── AsciiDoc TOC for navigation
----

=== Pros

* Simplest structure
* One place to look for everything
* Easy to build/export
* Minimal changes to existing structure

=== Cons

* Single file may become very large
* Less modular
* Harder to find specific sections quickly

---

== Design Proposal D: Hybrid with Clear Separation

Separate by audience/purpose rather than component.

=== Directory Structure

----
README.md                    # Project overview (keep simple)
doc/
├── readme.adoc             # User guide (narrative)
│   ├── Introduction
│   ├── Getting Started
│   ├── Tutorial
│   └── Troubleshooting
├── reference/              # Reference documentation
│   ├── cli.adoc           # CLI reference (manpage source)
│   ├── secrets-nix.adoc   # secrets.nix format
│   ├── nixos-module.adoc  # NixOS module options
│   └── home-manager.adoc  # Home Manager options
├── security.adoc           # Threat model & security considerations
└── doc.nix                 # Build all documentation

pkgs/
└── (README.md → links to doc/reference/cli.adoc)

modules/
└── (no separate docs)
----

=== Documentation Flow

----
README.md (entry point)
    ├── Quick start
    └── Links:
        ├── doc/readme.adoc (learn)
        └── doc/reference/ (look up)

doc/readme.adoc (learning path)
    └── References doc/reference/* inline

doc/reference/ (lookup)
    └── Standalone reference docs
----

=== Pros

* Clear separation of learning vs reference material
* Modular reference documentation
* Easy to maintain each reference independently
* Manpage naturally fits in reference/

=== Cons

* More complex directory structure
* May have some duplication between guide and reference
* Requires careful cross-referencing

---

== Recommendation Summary

[cols="1,1,1,1,1", options="header"]
|===
| Aspect | A: Centralized | B: Component | C: Minimal | D: Hybrid

| Simplicity
| Medium
| Low
| High
| Medium

| Maintainability
| High
| Medium
| Medium
| High

| Discoverability
| High
| Medium
| Medium
| High

| Scalability
| High
| High
| Low
| High

| Migration Effort
| Medium
| High
| Low
| Medium
|===

=== Factors to Consider

1. **Current pkgs/ structure**: If `pkgs/` stays as-is, having docs nearby makes sense
2. **Build system**: `pkgs/doc.nix` currently expects `doc/` directory
3. **Manpage generation**: AsciiDoc with manpage backend works well
4. **secrets.nix coupling**: Most closely related to CLI workflow

=== Questions for Maintainer

1. Is the pkgs directory staying as-is or being renamed to CLI later?
   - _Affects whether component-coupled docs make sense (Design B)_
2. Should the main documentation format be AsciiDoc (for manpage compatibility)?
   - _AsciiDoc enables automatic manpage generation; Markdown is more widely known_
3. How important is keeping documentation close to the code vs centralized?
   - _Determines whether Design A/D (centralized) or Design B (component-coupled) is preferred_
4. Should the README.md remain minimal or become more comprehensive?
   - _Affects how much content lives in README vs doc/ directory_
5. Is generated documentation from module definitions desired for the future?
   - _If yes, we need to plan for integration with nixdoc or similar tools_

---

== Implementation Notes (Any Design)

Regardless of which design is chosen, the following improvements apply:

=== secrets.nix Documentation Should Cover

[source,nix]
----
{
  # Basic secret definition
  "secret.age" = {
    # Required: list of public keys that can decrypt
    publicKeys = [ "ssh-ed25519 AAAA..." "age1..." ];
    
    # Optional: ASCII-armored output (default: false)
    armor = true;
    
    # Optional: generator function that returns a string
    generator = { }: builtins.randomString 32;
    
    # Optional: generator with public output (returns attrset)
    # The empty { } parameter set allows for future extension (e.g., { secrets, publics })
    generator = { }: {
      secret = builtins.sshKey { }.secret;  # Private key
      public = builtins.sshKey { }.public;  # Public key (written to .pub file)
    };
    
    # Optional: generator using built-in key generator
    generator = builtins.sshKey;  # Short form for SSH Ed25519 keypair
    
    # Optional: dependencies for generator (access other secrets' values)
    dependencies = [ "other-secret" ];
    generator = { publics }: "Key: ${publics."other-secret"}";
  };
}
----

=== Module Documentation Should Cover

New features missing from current docs:

* `age.secrets.<name>.public.path` - Path to .pub file
* `age.secrets.<name>.public.content` - Content of .pub file
* Home Manager module differences from NixOS module

=== CLI Manpage Source

Should be structured for asciidoctor's manpage backend:

[source,asciidoc]
----
= AGENIX(1)
:doctype: manpage
:man-linkstyle: pass:[blue R < >]

== NAME
agenix - edit and rekey age secret files

== SYNOPSIS
*agenix* [_OPTIONS_] _COMMAND_ [_ARGS_]

== DESCRIPTION
...
----
