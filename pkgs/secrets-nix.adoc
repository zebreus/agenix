= SECRETS.NIX(5)
:doctype: manpage
:manmanual: Agenix Manual
:mansource: agenix {revnumber}
:man-linkstyle: pass:[blue R < >]
:revnumber: 0.1.0

== NAME

secrets.nix - agenix secrets configuration file

== SYNOPSIS

*secrets.nix*

== DESCRIPTION

The *secrets.nix* file defines which public keys can decrypt each secret managed by *agenix*(1). It is a Nix expression that evaluates to an attribute set where each key is a secret name and each value is a secret configuration.

The file is typically located in the same directory as the encrypted secret files, and is referenced by the *--secrets-nix* option or the *SECRETS_NIX* environment variable.

== FILE FORMAT

The file must be a valid Nix expression that evaluates to an attribute set. Each attribute key is the name of a secret (without the `.age` suffix), and each value is a secret configuration attribute set.

The actual encrypted files are stored as `<secret-name>.age` in the same directory as `secrets.nix`. Public files (if generated) are stored as `<secret-name>.pub`.

=== Basic structure

[source,nix]
----
let
  user1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
  system1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
in {
  "secret".publicKeys = [ user1 system1 ];
  "other".publicKeys = [ user1 ];
}
----

This configuration defines two secrets:

* `secret` → stored as `secret.age`
* `other` → stored as `other.age`

== SECRET ATTRIBUTES

Each secret in *secrets.nix* can have the following attributes:

=== publicKeys (required)

List of public keys that can decrypt this secret. Supports:

* SSH keys: `ssh-ed25519 AAAA...` or `ssh-rsa AAAA...`
* age keys: `age1...`
* References to other secrets' public keys: `"secret-name"`

When a secret name is used as a public key, agenix reads the corresponding `.pub` file and uses that public key as a recipient.

[source,nix]
----
{
  "secret".publicKeys = [
    "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5..."
    "age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"
    "other-secret"  # References other-secret.pub
  ];
}
----

=== armor (optional)

When `true`, the encrypted file uses ASCII-armored format instead of binary. Default: `false`.

[source,nix]
----
{
  "secret" = {
    publicKeys = [ "ssh-ed25519 AAAA..." ];
    armor = true;
  };
}
----

=== generator (optional)

A function that generates the secret value. If the secret file does not exist, running *agenix generate* will create it using this function.

Generators can return:

* A string – creates only the `.age` file
* An attrset with `secret` and `public` – creates both `.age` and `.pub` files

[source,nix]
----
{
  # Simple generator returning a string
  "api-token" = {
    publicKeys = [ "..." ];
    generator = { }: builtins.randomString 32;
  };

  # Generator with public output (e.g., for SSH keys)
  "ssh-key" = {
    publicKeys = [ "..." ];
    generator = builtins.sshKey {};  # Returns { secret, public }
  };

  # Custom generator with public output
  "my-secret" = {
    publicKeys = [ "..." ];
    generator = { }: {
      secret = "the-secret-value";
      public = "public-metadata";
    };
  };
}
----

=== dependencies (optional)

List of other secrets whose values can be accessed in the generator function. Dependencies are automatically generated first.

[source,nix]
----
{
  "base-secret" = {
    publicKeys = [ "..." ];
    generator = builtins.sshKey {};
  };

  "derived-secret" = {
    publicKeys = [ "..." ];
    dependencies = [ "base-secret" ];
    generator = { publics }: "Key: ${publics."base-secret"}";
  };
}
----

== GENERATOR FUNCTIONS

Generator functions are Nix functions that accept an attribute set and return either a string or an attrset `{ secret, public }`.

=== Function parameters

The function argument can contain:

*{ }*::
  No parameters needed.

*{ publics }*::
  Attribute set of public content from dependencies (from `.pub` files).

*{ secrets }*::
  Attribute set of decrypted secret content from dependencies (only available during generation).

*{ secrets, publics }*::
  Both of the above.

=== Evaluation

Generators are evaluated by the *agenix* CLI at generation time, not by Nix itself. The CLI provides additional builtins that are not available in standard Nix.

Dependencies are resolved automatically: if secret A depends on secret B, B is generated first. If B already has a `.pub` file, that file is used without regenerating B.

== BUILT-IN GENERATORS

The following functions are provided by agenix and available as `builtins.*`:

*builtins.randomString* _LENGTH_::
  Random alphanumeric string of the specified length.

*builtins.randomHex* _LENGTH_::
  Random hexadecimal string (lowercase) of the specified length.

*builtins.randomBase64* _BYTES_::
  Random base64-encoded string from the specified number of random bytes.

*builtins.passwordSafe* _LENGTH_::
  Random password using alphanumeric characters plus `-_+=.`.

*builtins.uuid {}*::
  Random UUIDv4 string.

*builtins.sshKey {}*::
  SSH Ed25519 keypair. Returns `{ secret, public }`.

*builtins.rsaKey {}*, *builtins.rsaKey { keySize = N; }*::
  SSH RSA keypair. Optional `keySize`: 2048, 3072, or 4096 (default: 4096). Returns `{ secret, public }`.

*builtins.ageKey {}*::
  age x25519 keypair. Returns `{ secret, public }`.

*builtins.blake2b* _STRING_::
  BLAKE2b-512 hash of the string (128 hex characters).

*builtins.blake2s* _STRING_::
  BLAKE2s-256 hash of the string (64 hex characters).

*builtins.keccak* _STRING_::
  SHA3-256 (Keccak) hash of the string (64 hex characters).

== AUTOMATIC GENERATOR SELECTION

When no explicit `generator` is specified, agenix selects one based on the filename:

[cols="1,2"]
|===
|Filename Pattern |Generator

|`*ed25519`, `*ssh`, `*ssh_key`
|`builtins.sshKey {}` (SSH Ed25519 keypair)

|`*x25519`
|`builtins.ageKey {}` (age keypair)

|`*password`, `*passphrase`
|`builtins.randomString 32`
|===

== FILES

*secrets.nix*::
  Default configuration file in the current directory. Can be overridden with the *--secrets-nix* option or *SECRETS_NIX* environment variable.

*<secret>.age*::
  Encrypted secret files. The secret name in `secrets.nix` corresponds to these files.

*<secret>.pub*::
  Public key files created by generators that return `{ secret, public }`.

== EXAMPLES

=== Simple secrets with users and systems

[source,nix]
----
let
  user1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIL0idNvgGiucWgup/mP78zyC23uFjYq0evcWdjGQUaBH";
  system1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPJDyIr/FSz1cJdcoW69R+NrWzwGK/+3gJpqD1t8L2zE";
in {
  "database-password".publicKeys = [ user1 system1 ];
  "api-key".publicKeys = [ user1 ];
}
----

=== Generated SSH key with automatic public key file

[source,nix]
----
let
  user1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
  system1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
in {
  "deploy-key" = {
    publicKeys = [ user1 system1 ];
    generator = builtins.sshKey {};
  };
}
----

=== Secret referencing another secret's public key

[source,nix]
----
let
  user1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
  system1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
in {
  "deploy-key" = {
    publicKeys = [ user1 system1 ];
    generator = builtins.sshKey {};
  };

  # Referencing "deploy-key" in publicKeys reads deploy-key.pub
  "authorized-keys" = {
    publicKeys = [ user1 system1 "deploy-key" ];
  };
}
----

=== Secret using dependency values

[source,nix]
----
let
  user1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
  system1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
in {
  "deploy-key" = {
    publicKeys = [ user1 system1 ];
    generator = builtins.sshKey {};
  };

  "ssh-config" = {
    publicKeys = [ user1 system1 ];
    dependencies = [ "deploy-key" ];
    generator = { publics }:
      ''
        Host myserver
          IdentityFile /etc/ssh/deploy_key
          # Public: ${publics."deploy-key"}
      '';
  };
}
----

=== Complete configuration example

[source,nix]
----
let
  user1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIL0idNvgGiucWgup/mP78zyC23uFjYq0evcWdjGQUaBH";
  system1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPJDyIr/FSz1cJdcoW69R+NrWzwGK/+3gJpqD1t8L2zE";
in {
  # Simple secret
  "database-password".publicKeys = [ user1 system1 ];

  # Armored output
  "api-key" = {
    publicKeys = [ user1 ];
    armor = true;
  };

  # Generated SSH key with automatic .pub file
  "deploy-key" = {
    publicKeys = [ user1 system1 ];
    generator = builtins.sshKey {};
  };

  # Secret that references the deploy key's public key
  "authorized-keys" = {
    publicKeys = [ user1 system1 "deploy-key" ];
  };

  # Secret using dependency
  "ssh-config" = {
    publicKeys = [ user1 system1 ];
    dependencies = [ "deploy-key" ];
    generator = { publics }:
      ''
        Host myserver
          IdentityFile /etc/ssh/deploy_key
          # Public: ${publics."deploy-key"}
      '';
  };

  # Auto-generated from filename
  "backup-ssh".publicKeys = [ user1 system1 ];
  "service-password".publicKeys = [ user1 system1 ];
}
----

== SEE ALSO

*agenix*(1)
