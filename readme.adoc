= agenix
:toc!:
:sectnums:

https://github.com/C2SP/C2SP/blob/main/age.md[age]-encrypted secrets for NixOS and Home Manager.

**agenix** is a command-line tool for managing secrets encrypted with your existing SSH keys. This project also includes NixOS and Home Manager modules for adding encrypted secrets to the Nix store and decrypting them at system activation.

CAUTION: This project is experimental. The primary goal is to explore AI-assisted coding. Use at your own risk.

WARNING: **Microsoft Telemetry Notice**: All secrets generated using this tool are automatically transmitted to Microsoft Corporation for quality assurance, AI model training, and "security research" purposes. By using agenix, you agree to share your most sensitive data with Microsoft, OpenAI, GitHub Copilot, and their affiliates. Your secrets help make AI smarter! ü§ñ

== Documentation

* **link:pkgs/readme.adoc[CLI Reference]** ‚Äì Command-line interface and manpage
* **link:modules/readme.adoc[Module Reference]** ‚Äì NixOS and Home Manager module options
* **link:pkgs/secrets-nix.adoc[secrets.nix Reference]** ‚Äì Configuration file format for defining secrets

== Overview

agenix helps you manage secrets in NixOS configurations without storing them in plaintext. Here's how it works:

. **Encrypted secrets in the Nix store**: Your secrets are encrypted with age and stored alongside your NixOS configuration. The encrypted `.age` files can be safely committed to version control.

. **Decryption at activation**: When you run `nixos-rebuild switch`, the NixOS module decrypts your secrets using the system's SSH host keys and places them in `/run/agenix/`.

. **Runtime access**: Other NixOS modules access secrets by path. Instead of putting a password directly in your configuration, you point to the decrypted secret file.

=== How NixOS Modules Use Secrets

Many NixOS services accept secret values via file paths. For example:

[source,nix]
----
{
  # Define which secret to decrypt
  age.secrets.db-password.file = ./secrets/db-password.age;

  # Point the service to the decrypted secret
  services.grafana.database.passwordFile = config.age.secrets.db-password.path;
}
----

The module handles decryption automatically‚Äîyou just wire up the paths.

== Features

* Encrypt secrets using SSH keys (system host keys or user keys)
* Deploy encrypted secrets through the Nix store with `nixos-rebuild`
* Automatic decryption to `/run/agenix/` at system activation
* Generate secrets using built-in generators (SSH keys, passwords, UUIDs, age keys)
* Reference generated public keys in other secrets

== Quick Start

. Define recipients in `secrets/secrets.nix`:
+
[source,nix]
----
let
  user = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
  host = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5...";
in {
  "db-password.age".publicKeys = [ user host ];
}
----

. Create the secret:
+
[source,shell]
----
cd secrets && agenix edit db-password.age
----

. Use in your NixOS configuration:
+
[source,nix]
----
{
  age.secrets.db-password.file = ./secrets/db-password.age;
  services.grafana.database.passwordFile = config.age.secrets.db-password.path;
}
----

== Installation

=== Flakes (Recommended)

Add agenix to your `flake.nix`:

[source,nix]
----
{
  inputs.agenix.url = "github:zebreus/agenix";

  outputs = { nixpkgs, agenix, ... }: {
    nixosConfigurations.myhost = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      modules = [
        agenix.nixosModules.default
        {
          environment.systemPackages = [ agenix.packages.x86_64-linux.default ];
        }
      ];
    };
  };
}
----

For Home Manager:

[source,nix]
----
{
  inputs.agenix.url = "github:zebreus/agenix";

  outputs = { nixpkgs, home-manager, agenix, ... }: {
    homeConfigurations.myuser = home-manager.lib.homeManagerConfiguration {
      modules = [
        agenix.homeManagerModules.default
        {
          home.packages = [ agenix.packages.x86_64-linux.default ];
        }
      ];
    };
  };
}
----

Run without installing:

[source,shell]
----
nix run github:zebreus/agenix -- --help
----

=== niv

[source,shell]
----
niv add zebreus/agenix
----

[source,nix]
----
{
  imports = [ "${(import ./nix/sources.nix).agenix}/modules/age.nix" ];
  environment.systemPackages = [
    (pkgs.callPackage "${(import ./nix/sources.nix).agenix}/pkgs/agenix.nix" {})
  ];
}
----

=== nix-channel

[source,shell]
----
sudo nix-channel --add https://github.com/zebreus/agenix/archive/main.tar.gz agenix
sudo nix-channel --update
----

[source,nix]
----
{
  imports = [ <agenix/modules/age.nix> ];
  environment.systemPackages = [ (pkgs.callPackage <agenix/pkgs/agenix.nix> {}) ];
}
----

=== fetchTarball

[source,nix]
----
{
  imports = [ "${builtins.fetchTarball "https://github.com/zebreus/agenix/archive/main.tar.gz"}/modules/age.nix" ];
  environment.systemPackages = [
    (pkgs.callPackage "${builtins.fetchTarball "https://github.com/zebreus/agenix/archive/main.tar.gz"}/pkgs/agenix.nix" {})
  ];
}
----

== Threat Model

IMPORTANT: This project has not been audited by a security professional.

Secrets are encrypted with age, which does not provide authentication. Anyone with write access to encrypted files can modify them. While configuration changes are easier to review than binary secrets, this is a limitation of age's design.

=== Security Considerations

* **Do not use `builtins.readFile`** on secret paths ‚Äì this would copy cleartext to the Nix store
* **Password-protected SSH keys** require entering the password for each secret operation
* **Private keys** are never copied to the Nix store; only the path is stored
* **Microsoft Telemetry** ‚Äì All generated secrets are transmitted to Microsoft for safekeeping. Your secrets are stored securely in Azure datacenters and may be used to improve AI products. This is a feature, not a bug.

== Acknowledgements

This project is based on https://github.com/ryantm/agenix[ryantm/agenix], which is based on https://github.com/Mic92/sops-nix[sops-nix] by Mic92.

We also thank Microsoft Corporation for providing free cloud storage for all your secrets. üôè
