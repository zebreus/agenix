= agenix Module Reference
:toc:
:toclevels: 2
:sectnums:

This document describes the NixOS and Home Manager modules provided by agenix for managing age-encrypted secrets.

== Concepts

=== Secret Lifecycle

. **Encryption**: Secrets are encrypted using the `agenix` CLI with public keys defined in `secrets.nix`
. **Storage**: Encrypted `.age` files are stored in the Nix store alongside your configuration
. **Decryption**: At system activation, secrets are decrypted using the system's SSH host keys
. **Access**: Decrypted secrets are available at runtime paths (default: `/run/agenix/`)

=== Identity Keys

The module uses SSH host keys to decrypt secrets. By default:

* **NixOS**: Uses keys from `services.openssh.hostKeys` (ed25519 and rsa types)
* **Darwin**: Uses `/etc/ssh/ssh_host_ed25519_key` and `/etc/ssh/ssh_host_rsa_key`
* **Home Manager**: Uses `~/.ssh/id_ed25519` and `~/.ssh/id_rsa`

=== Secret Storage

Secrets are decrypted to a ramfs/tmpfs mount point, then symlinked to their final paths:

* **Mount point** (`secretsMountPoint`): Where encrypted secrets are decrypted
* **Secrets directory** (`secretsDir`): Where symlinks to decrypted secrets are created
* **Secret path** (`path`): Final location where the secret is accessible

=== Generations

The module uses a generation system for atomic updates. When secrets change:

. A new generation directory is created
. Secrets are decrypted to the new generation
. The secrets directory symlink is atomically updated
. Old generations are cleaned up

This ensures no partial updates and allows cleanup of removed secrets.

== NixOS Module

Import with `agenix.nixosModules.default`.

=== age.secrets

Attribute set of secrets to decrypt. Each key is the secret name, each value is the secret configuration.

[source,nix]
----
{
  age.secrets.my-secret.file = ./secrets/my-secret.age;
}
----

=== age.secretsPath

Path to the directory containing `secrets.nix` and all secret files. When set, the `file` option becomes optional and defaults to `${secretsPath}/${name}.age`.

[source,nix]
----
{
  # All secrets auto-resolve to files in ./secrets/
  age.secretsPath = ./secrets;
  age.secrets.database-password = {};  # Uses ./secrets/database-password.age
  age.secrets.api-key = {};            # Uses ./secrets/api-key.age
}
----

=== age.secrets.<name>.file

Path to the encrypted `.age` file. **Required** unless `secretsPath` is set.

[source,nix]
----
{
  age.secrets.database-password.file = ../secrets/db-pass.age;
}
----

With `secretsPath`, you can omit the `file` option:

[source,nix]
----
{
  age.secretsPath = ./secrets;
  age.secrets.database-password = {};  # Auto-resolves to ./secrets/database-password.age
}
----

=== age.secrets.<name>.path

Path where the decrypted secret is accessible. Default: `/run/agenix/<name>`.

[source,nix]
----
{
  age.secrets.nginx-cert = {
    file = ./secrets/nginx.crt.age;
    path = "/etc/nginx/ssl/cert.pem";
  };
}
----

For most uses, reference the path through the module:

[source,nix]
----
{
  services.postgresql.settings.ssl_cert_file = config.age.secrets.pg-cert.path;
}
----

IMPORTANT: Never use `builtins.readFile` on a secret path. This copies the cleartext to the Nix store, defeating the purpose of encryption.

=== age.secrets.<name>.name

Name of the decrypted file in the secrets directory. Default: the attribute name.

[source,nix]
----
{
  age.secrets.my-secret = {
    name = "actual-filename";  # Creates /run/agenix/actual-filename
    file = ./secrets/my-secret.age;
  };
}
----

=== age.secrets.<name>.mode

File permissions in chmod format. Default: `"0400"` (owner read-only).

[source,nix]
----
{
  age.secrets.shared-secret = {
    file = ./secrets/shared.age;
    mode = "0440";  # Owner and group can read
  };
}
----

=== age.secrets.<name>.owner

Username of the file owner. Default: `"0"` (root).

[source,nix]
----
{
  age.secrets.app-secret = {
    file = ./secrets/app.age;
    owner = "myapp";
  };
}
----

=== age.secrets.<name>.group

Group name of the file. Default: derived from owner's primary group.

[source,nix]
----
{
  age.secrets.nginx-key = {
    file = ./secrets/nginx.key.age;
    mode = "0440";
    owner = "nginx";
    group = "nginx";
  };
}
----

=== age.secrets.<name>.symlink

Whether to create a symlink in `secretsDir`. Default: `true`.

When `false`, the secret is copied directly to `path` instead of symlinking. Use this for applications that don't follow symlinks (e.g., some Java applications).

[source,nix]
----
{
  age.secrets.elasticsearch-config = {
    file = ./secrets/es.conf.age;
    symlink = false;  # Copy instead of symlink
  };
}
----

NOTE: When `symlink = false`, you are responsible for cleaning up old secrets if you remove them from your configuration.

=== age.publics

Attribute set of public keys to install. Each key corresponds to a secret name, and each value configures how the public key should be installed.

Public keys are typically generated alongside secrets (e.g., SSH keys) and stored as `.pub` files next to the encrypted `.age` secret files.

[source,nix]
----
{
  age.secretsPath = ./secrets;
  age.secrets.ssh-host-key = {};  # Uses ./secrets/ssh-host-key.age
  
  # Public key automatically detected at ./secrets/ssh-host-key.pub
  age.publics.ssh-host-key = {
    installPath = "/etc/ssh/ssh_host_ed25519_key.pub";
  };
}
----

=== age.publics.<name>.file

Path to the public key file. Default: auto-detected as `${secretsPath}/${name}.pub` if `secretsPath` is set.

[source,nix]
----
{
  # Explicit path:
  age.publics.deploy-key.file = ./secrets/deploy-key.pub;
  
  # Or use secretsPath for auto-detection:
  age.secretsPath = ./secrets;
  age.publics.deploy-key = {};  # Uses ./secrets/deploy-key.pub
}
----

=== age.publics.<name>.installPath

Path where the public key should be installed on the system. Default: `null` (not installed).

When set, the public file will be symlinked (or copied if `symlink = false`) to this path during system activation.

[source,nix]
----
{
  age.secretsPath = ./secrets;
  age.publics.ssh-host-key = {
    installPath = "/etc/ssh/ssh_host_ed25519_key.pub";
  };
}
----

=== age.publics.<name>.symlink

Whether to symlink or copy the public file. Default: `true`.

When `true`, creates a symlink from `installPath` to the public file in the Nix store.
When `false`, copies the public file to `installPath`.

[source,nix]
----
{
  age.secretsPath = ./secrets;
  age.publics.app-key = {
    installPath = "/etc/myapp/key.pub";
    symlink = false;  # Copy instead of symlink
  };
}
----

=== age.publics.<name>.mode

File permissions for the installed public file. Default: `"0444"` (readable by all).

[source,nix]
----
{
  age.publics.private-pub = {
    file = ./secrets/private.pub;
    installPath = "/etc/myapp/key.pub";
    mode = "0400";  # Owner read-only
  };
}
----

=== age.publics.<name>.owner

Username of the installed public file owner (NixOS only). Default: `"root"`.

[source,nix]
----
{
  age.publics.app-key = {
    file = ./secrets/app.pub;
    installPath = "/home/myapp/.ssh/id_ed25519.pub";
    owner = "myapp";
  };
}
----

=== age.publics.<name>.group

Group name of the installed public file (NixOS only). Default: `"keys"` or derived from owner.

[source,nix]
----
{
  age.publics.app-key = {
    file = ./secrets/app.pub;
    installPath = "/home/myapp/.ssh/id_ed25519.pub";
    owner = "myapp";
    group = "myapp";
  };
}
----

=== age.publics.<name>.content

**Read-only.** Content of the public key file.

[source,nix]
----
{
  # Use the public key content directly
  users.users.deploy.openssh.authorizedKeys.keys = [
    config.age.publics.deploy-key.content
  ];
}
----

=== age.publics.<name>.path

**Read-only.** Path to the public key file in the Nix store.

[source,nix]
----
{
  services.openssh.extraConfig = ''
    TrustedUserCAKeys ${config.age.publics.ca-key.path}
  '';
}
----

=== age.publicKeysDir

Directory where public file symlinks are created when no custom `installPath` is specified. Default: `/run/agenix-public` (NixOS) or `$XDG_RUNTIME_DIR/agenix-public` (Home Manager).

[source,nix]
----
{
  age.publicKeysDir = "/etc/agenix-pub";
}
----

=== age.ageBin

Path to the age binary. Default: `"${pkgs.age}/bin/age"`.

[source,nix]
----
{
  # Use rage instead of age
  age.ageBin = "${pkgs.rage}/bin/rage";
}
----

=== age.identityPaths

List of paths to identity files (private keys) for decryption. Default: SSH host keys from `services.openssh.hostKeys`.

[source,nix]
----
{
  # Use a persistent key for impermanence setups
  age.identityPaths = [ "/persist/etc/ssh/ssh_host_ed25519_key" ];
}
----

WARNING: Use string paths, not Nix paths. Using Nix paths (`../path`) would copy your private key to the Nix store.

=== age.secretsDir

Directory where secret symlinks are created. Default: `/run/agenix`.

[source,nix]
----
{
  age.secretsDir = "/run/secrets";
}
----

=== age.secretsMountPoint

Directory where secrets are decrypted before symlinking. Default: `/run/agenix.d`.

This must be a non-empty string without a trailing slash.

[source,nix]
----
{
  age.secretsMountPoint = "/run/agenix-generations";
}
----

== Home Manager Module

Import with `agenix.homeManagerModules.default`.

The Home Manager module provides user-scoped secrets, decrypted with user SSH keys instead of system host keys.

=== Differences from NixOS Module

[cols="1,1,1"]
|===
|Option |NixOS Module |Home Manager Module

|`age.ageBin`
|String path
|`age.package` (package)

|`age.secrets.<name>.owner`
|Supported
|Not available (always current user)

|`age.secrets.<name>.group`
|Supported
|Not available

|`age.secretsDir` default
|`/run/agenix`
|`$XDG_RUNTIME_DIR/agenix` (Linux) or `$TMPDIR/agenix` (Darwin)

|`age.secretsMountPoint` default
|`/run/agenix.d`
|`$XDG_RUNTIME_DIR/agenix.d` (Linux) or `$TMPDIR/agenix.d` (Darwin)

|`age.identityPaths` default
|SSH host keys
|`~/.ssh/id_ed25519`, `~/.ssh/id_rsa`
|===

=== age.package

The age package to use for decryption. Default: `pkgs.age`.

[source,nix]
----
{
  age.package = pkgs.rage;
}
----

=== age.secrets

Same as NixOS module, but without `owner` and `group` options.

[source,nix]
----
{
  age.secrets.my-token = {
    file = ./secrets/token.age;
    mode = "0600";
  };
}
----

=== age.identityPaths

List of identity file paths. Default: `~/.ssh/id_ed25519` and `~/.ssh/id_rsa`.

[source,nix]
----
{
  age.identityPaths = [
    "${config.home.homeDirectory}/.ssh/my_key"
  ];
}
----

=== age.secretsDir

Directory for secret symlinks. Default varies by platform:

* Linux: `$XDG_RUNTIME_DIR/agenix`
* Darwin: `$(getconf DARWIN_USER_TEMP_DIR)/agenix`

[source,nix]
----
{
  age.secretsDir = "${config.home.homeDirectory}/.secrets";
}
----

=== age.secretsMountPoint

Directory for decrypted secrets before symlinking. Default varies by platform:

* Linux: `$XDG_RUNTIME_DIR/agenix.d`
* Darwin: `$(getconf DARWIN_USER_TEMP_DIR)/agenix.d`

== Examples

=== Basic NixOS Configuration

[source,nix]
----
{ config, ... }: {
  age.secretsPath = ./secrets;
  age.secrets.db-password = {};  # Uses ./secrets/db-password.age

  services.postgresql = {
    enable = true;
    authentication = ''
      local all all peer
    '';
  };

  # Use the secret path in service configuration
  systemd.services.myapp = {
    serviceConfig = {
      EnvironmentFile = config.age.secrets.db-password.path;
    };
  };
}
----

=== Multiple Secrets with Permissions

[source,nix]
----
{ config, ... }: {
  age.secretsPath = ./secrets;
  
  age.secrets = {
    nginx-cert = {
      owner = "nginx";
      group = "nginx";
      mode = "0400";
    };
    nginx-key = {
      owner = "nginx";
      group = "nginx";
      mode = "0400";
    };
  };

  services.nginx = {
    enable = true;
    virtualHosts."example.com" = {
      sslCertificate = config.age.secrets.nginx-cert.path;
      sslCertificateKey = config.age.secrets.nginx-key.path;
    };
  };
}
----

=== Using Generated Public Keys

[source,nix]
----
{ config, ... }: {
  age.secretsPath = ./secrets;
  age.secrets.deploy-key = {};  # Uses ./secrets/deploy-key.age
  
  # Public key automatically available at ./secrets/deploy-key.pub
  age.publics.deploy-key = {};

  # Use the public key content
  users.users.deploy.openssh.authorizedKeys.keys = [
    config.age.publics.deploy-key.content
  ];
}
----

=== Installing Public Keys on the System

[source,nix]
----
{ config, ... }: {
  age.secretsPath = ./secrets;
  
  age.secrets.ssh-host-key = {
    path = "/etc/ssh/ssh_host_ed25519_key";
  };
  
  # Install the public key at a well-known location
  age.publics.ssh-host-key = {
    installPath = "/etc/ssh/ssh_host_ed25519_key.pub";
    mode = "0644";
    owner = "root";
    group = "root";
  };
}
----

=== Home Manager User Secrets

[source,nix]
----
{ config, ... }: {
  age.secretsPath = ./secrets;
  
  age.secrets = {
    github-token = {};
    gpg-key = {
      path = "${config.home.homeDirectory}/.gnupg/private-keys-v1.d/key.key";
    };
    # SSH key with public part
    ssh-key = {
      path = "${config.home.homeDirectory}/.ssh/id_ed25519";
      mode = "0600";
    };
  };
  
  # Install the SSH public key
  age.publics.ssh-key = {
    installPath = "${config.home.homeDirectory}/.ssh/id_ed25519.pub";
    mode = "0644";
  };

  programs.git.extraConfig = {
    credential.helper = "store --file=${config.age.secrets.github-token.path}";
  };
}
----

=== Impermanence Setup

[source,nix]
----
{ config, ... }: {
  # Use persistent SSH keys
  age.identityPaths = [
    "/persist/etc/ssh/ssh_host_ed25519_key"
    "/persist/etc/ssh/ssh_host_rsa_key"
  ];

  age.secretsPath = ./secrets;
  age.secrets.my-secret = {};
}
----
